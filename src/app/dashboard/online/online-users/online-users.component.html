<!-- src/app/dashboard/online-users/online-users.component.html -->
<div class="ui-container online-users mt-3" [attr.aria-busy]="loading ? 'true' : 'false'">
  <h2 class="online-users-title mb-3">Perfis Online</h2>

  @let u = (currentUser() ?? (currentUserStore.user$ | async));

  @if (u === undefined) {
  <div class="alert alert-secondary" role="status" aria-live="polite">
    Carregando sessão…
  </div>
  } @else if (u === null) {
  <div class="alert alert-secondary" role="status" aria-live="polite">
    Entre na sua conta para ver e filtrar perfis online perto de você.
  </div>
  } @else {

  @if (!u?.emailVerified) {
  <div class="alert alert-warning" role="status" aria-live="polite">
    Sua conta não verificada limita a precisão e o raio de busca para proteger sua privacidade.
  </div>
  }

  @if (!userLocation) {
  <div class="alert alert-info" role="status" aria-live="polite">
    Ative sua localização para priorizar perfis online próximos a você.
  </div>

  <button type="button" class="btn btn-primary mb-3" (click)="enableLocation()" [disabled]="loading || !u?.uid"
    [attr.aria-busy]="loading ? 'true' : 'false'" [attr.aria-disabled]="(loading || !u?.uid) ? 'true' : 'false'"
    aria-describedby="onlineLocHelp">
    {{ loading ? 'Obtendo sua localização...' : 'Ativar localização' }}
  </button>

  <p id="onlineLocHelp" class="help-text">
    Só pedimos sua posição após um clique seu. Precisão e raio variam conforme seu plano e verificação.
  </p>
  } @else {

  <!-- Card de controle -->
  <div class="card mb-3 control-card" aria-labelledby="distControlTitleOnline">
    <div class="card-body">
      <div class="card-head">
        <h3 class="h6 m-0" id="distControlTitleOnline">Raio de busca</h3>

        <div class="head-actions">
          <!-- Ver todos -->
          <a class="btn btn-ghost icon-btn" routerLink="/online" aria-label="Ver todos os usuários">
            <i class="fas fa-users" aria-hidden="true"></i>
            <span class="hide-xs">Ver todos</span>
          </a>

          <!-- Atualizar posição (ícone mais apropriado) -->
          <button type="button" class="btn btn-ghost icon-btn" (click)="enableLocation()"
            [disabled]="loading || !u?.uid" [attr.aria-busy]="loading ? 'true' : 'false'"
            aria-label="Atualizar minha posição" title="Atualizar minha posição">
            <i class="fas fa-location-crosshairs" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- Slider + stepper -->
      <div class="range-toolbar mt-2" role="group" aria-label="Ajuste do raio de busca">
        <button class="step-btn" type="button" (click)="stepRange(-1)" aria-label="Diminuir raio">−</button>

        <div class="range-wrap">
          <input type="range" class="form-range enhanced-range" [(ngModel)]="uiDistanceKm"
            (ngModelChange)="onDistanceChange($event)" [min]="1" [max]="policyMaxDistanceKm" [step]="1"
            [style.background]="getRangeTrackBackground(uiDistanceKm)" aria-label="Raio de busca em quilômetros"
            list="km-ticks" />
          <output class="range-bubble" [style.left.%]="getRangeThumbPercent(uiDistanceKm)">
            {{ uiDistanceKm ?? policyMaxDistanceKm }} km
          </output>
        </div>

        <button class="step-btn" type="button" (click)="stepRange(1)" aria-label="Aumentar raio">+</button>
      </div>

      <datalist id="km-ticks">
        <option *ngFor="let t of [1,5,10,15,20,25,30,40,50]" [value]="t"></option>
      </datalist>

      <div class="range-legend">
        <span>1 km</span>
        <span>{{ uiDistanceKm ?? policyMaxDistanceKm }} / {{ policyMaxDistanceKm }} km</span>
      </div>

      <p class="help-text mt-2">
        O raio é limitado ao máximo permitido pelo seu plano e status de verificação.
      </p>
    </div>
  </div>

  <!-- Grid de cards -->
  <div class="profiles-grid mt-2">
    @if (onlineUsers$ | async; as users) {
    @if (users.length === 0) {
    <p class="help-text">Nenhum usuário online dentro do raio atual.</p>
    } @else {
    @for (user of users; track user.uid) {
    <app-user-card [user]="user" [distanciaKm]="user.distanciaKm ?? null"></app-user-card>
    }
    }
    } @else {
    <p class="help-text">Carregando usuários online…</p>
    }
  </div>
  }
  }
  <div class="mt-3 d-flex justify-content-end">
    <a class="btn btn-secondary" [routerLink]="['/dashboard','online']">
      Ver todos os online
    </a>
  </div>
</div>
