<!-- src/app/authentication/register-module/welcome/welcome.component.html -->
<div class="welcome-container">
  <header class="welcome-header">
    <h1>Confirme seu e-mail para come√ßar</h1>
    <p class="subtitle">
      Enviamos um link de verifica√ß√£o para <strong>{{ email || 'seu e-mail' }}</strong>.
      Assim que voc√™ confirmar, liberamos todos os recursos.
    </p>
  </header>

  <!-- Banner robusto (harmoniza com seus estilos globais .alert*) -->
  <div *ngIf="banner as b" class="alert" [ngClass]="{
         'alert-info': b.variant === 'info',
         'alert-error': b.variant === 'error',
         'alert-success': b.variant === 'success',
         'alert-warning': b.variant === 'warn' || b.variant,
       }" role="alert" aria-live="assertive" style="margin-bottom:16px;">
    <strong style="display:block; margin-bottom:4px;">{{ b.title }}</strong>
    <span>{{ b.message }}</span>
    <div *ngIf="lastCheckedAt" style="margin-top:6px; font-size:.85rem; opacity:.8;">
      √öltima checagem: {{ lastCheckedAt | date:'shortTime' }}
    </div>

    <div class="actions" style="margin-top:8px; display:flex; gap:.5rem; flex-wrap:wrap;">
      <button class="btn btn-secondary" (click)="checkNow()" [disabled]="busy" [attr.aria-busy]="busy">
        {{ busy ? 'Checando‚Ä¶' : 'Checar agora' }}
      </button>
      <button class="btn" (click)="resendVerificationEmail()" [disabled]="busy" [attr.aria-busy]="busy">
        {{ busy ? 'Reenviando‚Ä¶' : 'Reenviar e-mail' }}
      </button>
      <button class="btn" (click)="openInbox()">Abrir seu e-mail</button>
      <button class="btn" (click)="copyEmail()" [disabled]="!email">Copiar e-mail</button>
      <button class="btn" (click)="toggleTech()">
        {{ showTech ? 'Ocultar detalhes' : 'Mostrar detalhes t√©cnicos' }}
      </button>
      <button class="btn" (click)="reloadPage()">Recarregar</button>
      <button class="btn" (click)="restartRegistration()">Refazer cadastro</button>
      <button class="btn btn-primary" *ngIf="emailVerified" (click)="proceedToDashboard()">Ir para o painel</button>
    </div>

    <pre *ngIf="showTech && b.details"
      style="margin-top:8px; white-space:pre-wrap; font-size:.85rem; background:rgba(0,0,0,.05); padding:8px; border-radius:8px; overflow:auto;">
{{ b.details }}
    </pre>
  </div>

  <main class="welcome-content">
    <section class="welcome-card">
      <h2 class="card-title">
        Status:
        <span *ngIf="emailVerified; else notVerified" class="badge ok">verificado</span>
        <ng-template #notVerified><span class="badge warn">n√£o verificado</span></ng-template>
      </h2>

      <ol class="steps">
        <li>Abra sua caixa de entrada.</li>
        <li>Procure pelo e-mail ‚ÄúConfirme seu endere√ßo‚Äù.</li>
        <li>Clique no bot√£o do e-mail para confirmar.</li>
      </ol>

      <div class="actions">
        <button class="btn btn-primary" (click)="checkNow()" [disabled]="busy" [attr.aria-busy]="busy">
          {{ busy ? 'Checando‚Ä¶' : 'J√° verifiquei ‚Äî checar agora' }}
        </button>
        <button class="btn btn-secondary" (click)="resendVerificationEmail()" [disabled]="busy" [attr.aria-busy]="busy">
          {{ busy ? 'Reenviando‚Ä¶' : 'Reenviar e-mail' }}
        </button>
        <button class="btn" (click)="proceedToDashboard()" [disabled]="busy || !emailVerified">
          Ir para o painel
        </button>
      </div>
    </section>

    <!-- Onboarding opcional (colapsado) -->
    <details class="welcome-card details-optional">
      <summary>Quero adiantar meu perfil (opcional)</summary>

      <div class="optional-grid">
        <div>
          <label class="form-label">Identidade de g√™nero (opcional)</label>
          <select class="input-field" [(ngModel)]="selectedGender" aria-label="Selecione seu g√™nero">
            <option value="" disabled selected>Selecione seu g√™nero (opcional)</option>
            <option *ngFor="let gender of validGenders" [value]="gender">{{ gender }}</option>
          </select>
        </div>

        <div>
          <label class="form-label">O que voc√™ gostaria de encontrar? (opcional)</label>
          <div class="checkbox-group">
            <label class="checkbox-item" *ngFor="let preference of validPreferences">
              <input type="checkbox" [(ngModel)]="selectedPreferencesMap[preference]" />
              {{ preference }}
            </label>
          </div>
        </div>
      </div>

      <div class="actions right">
        <button class="btn btn-primary" (click)="saveOptionalProfile()" [disabled]="savingOptional || busy"
          [attr.aria-busy]="savingOptional">
          {{ savingOptional ? 'Salvando‚Ä¶' : 'Salvar prefer√™ncias' }}
        </button>
      </div>
    </details>

    <!-- Sucesso p√≥s-verifica√ß√£o: CTA destacado, sem auto-redirect brusco -->
    <section *ngIf="emailVerified" class="welcome-card success-card">
      <h2 class="card-title">Tudo certo! üéâ</h2>
      <p>Seu e-mail est√° verificado. Voc√™ pode seguir para o painel quando quiser.</p>
      <div class="actions">
        <button class="btn btn-primary" (click)="proceedToDashboard()">Ir para o painel</button>
      </div>
    </section>
  </main>
</div>

<!-- Estado de sess√£o inv√°lida (sem redirecionar para login) -->
<section *ngIf="sessionInvalid" class="welcome-card alert-error" style="border-left:4px solid #c62828;">
  <h2 class="card-title">Sess√£o encerrada</h2>
  <p>N√£o conseguimos manter sua sess√£o ativa durante a verifica√ß√£o. Voc√™ pode tentar reconectar ou refazer o cadastro.
  </p>
  <div class="actions">
    <button class="btn btn-secondary" (click)="checkNow()" [disabled]="busy" [attr.aria-busy]="busy">
      Tentar reconectar
    </button>
    <button class="btn btn-primary" (click)="restartRegistration()">Refazer cadastro</button>
  </div>
</section>
