<!-- src/app/register-module/register.component.html -->
<div class="auth-container">
  <div class="form-container">

    <!-- Banner robusto -->
    <div *ngIf="banner() as b" class="alert" [ngClass]="{
        'alert-info': b.variant === 'info',
        'alert-error': b.variant === 'error',
        'alert-success': b.variant === 'success',
        'alert-warning': b.variant === 'warn'
      }" role="alert" aria-live="assertive" style="margin-bottom:16px;">

      <strong style="display:block; margin-bottom:4px;">{{ b.title }}</strong>
      <span>{{ b.message }}</span>

      <div class="actions" style="margin-top:8px; display:flex; gap:.5rem; flex-wrap:wrap;">
        <button class="btn btn-secondary" type="button" (click)="onSubmit()" [disabled]="isLoading() || creating()">
          Tentar novamente
        </button>

        <button class="btn" type="button" (click)="syncSessionNow()" [disabled]="syncing()">
          Sincronizar sess√£o
        </button>

        <button class="btn" type="button" (click)="resetForm()" [disabled]="isLoading() || creating()">
          Refazer cadastro
        </button>

        <button class="btn" type="button" (click)="toggleTech()">
          {{ showTech() ? 'Ocultar detalhes' : 'Mostrar detalhes t√©cnicos' }}
        </button>

        <button class="btn" type="button" (click)="copyDetails()" *ngIf="b.details">
          Copiar detalhes
        </button>

        <button class="btn" type="button" (click)="reloadPage()">
          Recarregar
        </button>
      </div>

      <pre *ngIf="showTech() && b.details"
        style="margin-top:8px; white-space:pre-wrap; font-size:.85rem; background:rgba(0,0,0,.05); padding:8px; border-radius:8px; overflow:auto;">
{{ b.details }}</pre>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" aria-labelledby="form-title" autocomplete="on" novalidate
      [attr.aria-busy]="(isLoading() || creating()) ? 'true' : null">

      <h2 id="form-title" class="form-header">Cadastre-se</h2>

      <!-- Apelido principal -->
      <div class="form-field nickname-field">
        <label for="apelidoPrincipal">Apelido *</label>

        <div class="field-row">
          <div class="input-wrapper">
            <input id="apelidoPrincipal" formControlName="apelidoPrincipal" type="text" class="input-field"
              name="nickname" autocomplete="nickname" placeholder="Ex: casadinho" spellcheck="false"
              autocapitalize="none" inputmode="text" maxlength="12" aria-label="Apelido"
              aria-describedby="apelidoHelp apelidoTooltip" (input)="onNicknameTyping()" (blur)="onNicknameBlur()"
              [attr.aria-invalid]="
                (submitted() || form.get('apelidoPrincipal')?.touched || nicknameFeedbackArmed())
                && (form.get('apelidoPrincipal')?.invalid || form.hasError('invalidFullNickname'))
                  ? true
                  : null
              " [ngClass]="{
                'is-pending': nicknameChecking(),

                'is-invalid':
                  (submitted() || form.get('apelidoPrincipal')?.touched || nicknameFeedbackArmed())
                  && (form.get('apelidoPrincipal')?.invalid || form.hasError('invalidFullNickname')),

                'is-valid':
                  nicknameFeedbackArmed()
                  && !nicknameChecking()
                  && form.get('apelidoPrincipal')?.valid
                  && !form.hasError('invalidFullNickname')
                  && ((apelidoCompleto() || '').length >= 4)
                  && ((apelidoCompleto() || '').length <= 24)
                  && !apelidoEmUso()
                  && nicknameCheckState() === 'available'
              }" />
          </div>

          <div class="inline-feedback" aria-live="polite">
            <!-- Verificando -->
            <div *ngIf="nicknameChecking()" class="badge info">
              <span class="inline-spinner" aria-hidden="true"></span> Verificando‚Ä¶
            </div>

            <!-- Dispon√≠vel (s√≥ se apelido completo estiver v√°lido) -->
            <div *ngIf="
                !nicknameChecking()
                && nicknameFeedbackArmed()
                && form.get('apelidoPrincipal')?.valid
                && !form.hasError('invalidFullNickname')
                && ((apelidoCompleto() || '').length >= 4)
                && ((apelidoCompleto() || '').length <= 24)
                && !apelidoEmUso()
                && nicknameCheckState() === 'available'
              " class="badge ok">
              Dispon√≠vel
            </div>

            <!-- Em uso (s√≥ se apelido completo estiver v√°lido) -->
            <div *ngIf="
                !nicknameChecking()
                && (submitted() || nicknameFeedbackArmed())
                && !form.hasError('invalidFullNickname')
                && ((apelidoCompleto() || '').length >= 4)
                && ((apelidoCompleto() || '').length <= 24)
                && (apelidoEmUso() || nicknameCheckState() === 'taken')
              " class="badge error">
              Apelido em uso
            </div>

            <!-- N√£o verificado (s√≥ se apelido completo estiver v√°lido) -->
            <div *ngIf="
                !nicknameChecking()
                && nicknameFeedbackArmed()
                && !form.hasError('invalidFullNickname')
                && ((apelidoCompleto() || '').length >= 4)
                && ((apelidoCompleto() || '').length <= 24)
                && nicknameCheckState() === 'unverified'
                && !apelidoEmUso()
              " class="badge warn">
              N√£o foi poss√≠vel verificar agora
            </div>
          </div>
        </div>

        <div class="hint-row">
          <small id="apelidoHelp" class="field-hint">
            Nome principal pelo qual ser√° conhecido na plataforma.
          </small>

          <small class="char-counter" [class.warn]="(form.get('apelidoPrincipal')?.value?.length || 0) > 10">
            {{ (form.get('apelidoPrincipal')?.value?.length || 0) }}/12
          </small>
        </div>

        <!-- Pr√©via do apelido final -->
        <small class="field-hint" style="display:block; margin-top:.35rem;">
          Seu apelido ficar√° como: <strong>{{ apelidoCompleto() }}</strong>
          <span style="opacity:.8;"> ({{ (apelidoCompleto() || '').length }}/24)</span>
        </small>

        <!-- Tooltip do apelido:
             aparece ap√≥s submit OU ap√≥s ficar "armado" (blur/inatividade) e fora do estado "checking" -->
        <div *ngIf="
            getError('apelidoPrincipal')
            && (submitted() || nicknameFeedbackArmed())
            && !nicknameChecking()
          " id="apelidoTooltip" class="tooltip-error">
          {{ getError('apelidoPrincipal') }}
        </div>
      </div>

      <!-- Complemento do apelido -->
      <div class="form-field">
        <label for="complementoApelido">Complemento (opcional)</label>

        <input id="complementoApelido" formControlName="complementoApelido" type="text" class="input-field"
          name="nicknameSuffix" autocomplete="off" placeholder="Ex: oficial" autocapitalize="none" inputmode="text"
          maxlength="12" aria-label="Complemento do apelido" aria-describedby="complementoHelp complementoTooltip"
          (input)="onNicknameTyping()" (blur)="onComplementoBlur()" [attr.aria-invalid]="
            (submitted() || form.get('complementoApelido')?.touched)
            && form.get('complementoApelido')?.invalid
              ? true
              : null
          " [ngClass]="{
            'is-invalid': (submitted() || form.get('complementoApelido')?.touched) && form.get('complementoApelido')?.invalid,
            'is-valid': (submitted() || form.get('complementoApelido')?.touched) && form.get('complementoApelido')?.valid
          }" />

        <small id="complementoHelp" class="field-hint" style="display:block; margin-top:.35rem;">
          At√© 12 caracteres. O apelido completo pode ter at√© 24 no total.
        </small>

        <div *ngIf="getError('complementoApelido') && (submitted() || form.get('complementoApelido')?.touched)"
          id="complementoTooltip" class="tooltip-error">
          {{ getError('complementoApelido') }}
        </div>
      </div>

      <!-- Email -->
      <div class="form-field">
        <label for="email">E-mail *</label>

        <input id="email" formControlName="email" type="email" class="input-field" name="email" autocomplete="email"
          placeholder="email@exemplo.com" autocapitalize="none" inputmode="email" aria-label="E-mail"
          aria-describedby="emailTooltip" [attr.aria-invalid]="
            (submitted() || form.get('email')?.touched)
            && form.get('email')?.invalid
              ? true
              : null
          " [ngClass]="{
            'is-invalid': (submitted() || form.get('email')?.touched) && form.get('email')?.invalid,
            'is-valid': (submitted() || form.get('email')?.touched) && form.get('email')?.valid
          }" />

        <div *ngIf="getError('email') && (submitted() || form.get('email')?.touched)" id="emailTooltip"
          class="tooltip-error">
          {{ getError('email') }}
        </div>
      </div>

      <!-- Senha -->
      <div class="form-field">
        <label for="password">Senha *</label>

        <div class="input-wrapper">
          <input id="password" [type]="showPassword() ? 'text' : 'password'" formControlName="password"
            class="input-field" name="password" autocomplete="new-password" placeholder="Escolha uma senha"
            aria-label="Senha" aria-describedby="passwordTooltip passwordHelp" [attr.aria-invalid]="
              (submitted() || form.get('password')?.touched)
              && form.get('password')?.invalid
                ? true
                : null
            " [ngClass]="{
              'is-invalid': (submitted() || form.get('password')?.touched) && form.get('password')?.invalid,
              'is-valid': (submitted() || form.get('password')?.touched) && form.get('password')?.valid
            }" />

          <button type="button" class="toggle-input" (click)="togglePasswordVisibility()"
            [attr.aria-pressed]="showPassword() ? 'true' : 'false'"
            [attr.aria-label]="showPassword() ? 'Ocultar senha' : 'Mostrar senha'">
            {{ showPassword() ? 'üôà' : 'üëÅÔ∏è' }}
          </button>
        </div>

        <small id="passwordHelp" class="field-hint" style="display:block; margin-top:.35rem;">
          M√≠nimo de 6 caracteres.
        </small>

        <div *ngIf="getError('password') && (submitted() || form.get('password')?.touched)" id="passwordTooltip"
          class="tooltip-error">
          {{ getError('password') }}
        </div>
      </div>

      <!-- Aceite de Termos -->
      <div class="form-checkbox">
        <input type="checkbox" id="termos" formControlName="aceitarTermos" autocomplete="off"
          aria-describedby="termosTooltip" [attr.aria-invalid]="
            (submitted() || form.get('aceitarTermos')?.touched)
            && form.get('aceitarTermos')?.invalid
              ? true
              : null
          " />

        <label for="termos">
          Eu aceito os
          <a href="/termos" target="_blank" rel="noopener noreferrer">Termos de Uso</a>
          e a
          <a href="/politica-de-privacidade" target="_blank" rel="noopener noreferrer">Pol√≠tica de Privacidade</a>.
        </label>

        <div *ngIf="getError('aceitarTermos') && (submitted() || form.get('aceitarTermos')?.touched)" id="termosTooltip"
          class="tooltip-error">
          {{ getError('aceitarTermos') }}
        </div>
      </div>

      <!-- Mensagem neutra -->
      <p *ngIf="infoMessage()" class="alert alert-info" aria-live="polite">
        {{ infoMessage() }}
      </p>

      <button class="btn btn-primary" type="submit"
        [disabled]="isLoading() || creating() || nicknameChecking() || !form.valid">
        {{ isLoading() ? 'Aguarde‚Ä¶' : 'Cadastrar' }}
      </button>

      <p class="login-redirect">
        J√° tem conta?
        <a routerLink="/login">Fa√ßa login</a>
      </p>
    </form>
  </div>
</div>

<!-- Overlay de cria√ß√£o de usu√°rio -->
<div *ngIf="creating()" class="rg-overlay" role="status" aria-live="assertive" aria-label="Criando sua conta">

  <div class="rg-card">
    <div class="rg-spinner" aria-hidden="true"></div>
    <h3 class="rg-title">Criando sua conta</h3>
    <p class="rg-sub">{{ creatingMsg() }}</p>
  </div>
</div>
