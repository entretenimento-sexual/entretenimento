    // =========================================================================
    // ROOMS
    // =========================================================================
    match /rooms/{roomId} {
      function isRoomParticipant() {
        return signedIn() && (uid() in resource.data.participants);
      }
      function isRoomOwner() {
        return signedIn() && resource.data.createdBy == uid();
      }

      allow read: if isRoomParticipant();

      allow create: if signedIn()
        && request.resource.data.createdBy == uid()
        && request.resource.data.participants is list
        && (uid() in request.resource.data.participants)
        && isStr(request.resource.data.roomName)
        && ("creationTime" in request.resource.data) && isTs(request.resource.data.creationTime);

      allow update: if isRoomParticipant()
        && (
          (isRoomOwner()
            && request.resource.data.diff(resource.data).changedKeys().hasOnly([
              "roomName",
              "description",
              "expirationDate",
              "maxParticipants",
              "isPrivate",
              "roomType",
              "visibility",
              "participants",
              "lastActivity",
              "lastMessage"
            ])
          )
          ||
          (!isRoomOwner()
            && request.resource.data.diff(resource.data).changedKeys().hasOnly([
              "lastActivity",
              "lastMessage"
            ])
          )
        );

      allow delete: if false;
    }

    match /rooms/{roomId}/messages/{messageId} {
      function isRoomParticipantByRoom() {
        return signedIn()
          && (uid() in get(/databases/$(database)/documents/rooms/$(roomId)).data.participants);
      }

      function senderIsMeCreate() {
        return (request.resource.data.senderId == uid())
          || (("senderUid" in request.resource.data) && request.resource.data.senderUid == uid());
      }

      function messageHasTime() {
        return (("timestamp" in request.resource.data) && isTs(request.resource.data.timestamp))
          || (("createdAt" in request.resource.data) && isTs(request.resource.data.createdAt));
      }

      allow read: if isRoomParticipantByRoom();

      allow create: if isRoomParticipantByRoom()
        && senderIsMeCreate()
        && isStr(request.resource.data.content) && request.resource.data.content.size() > 0
        && isStr(request.resource.data.nickname)
        && messageHasTime()
        && (!("status" in request.resource.data) || request.resource.data.status == "sent");

      allow update: if isRoomParticipantByRoom()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(["status"])
        && request.resource.data.status in ["delivered","read"]
        && (
          (("senderId" in resource.data) && resource.data.senderId != uid())
          ||
          (("senderUid" in resource.data) && resource.data.senderUid != uid())
        );

      allow delete: if false;
    }

    match /rooms/{roomId}/invites/{inviteId} {
      function canSeeInvite() {
        return signedIn()
          && (resource.data.senderId == uid() || resource.data.receiverId == uid());
      }

      allow read: if canSeeInvite();

      allow create: if signedIn()
        && request.resource.data.senderId == uid()
        && request.resource.data.roomId == roomId
        && request.resource.data.receiverId != uid()
        && request.resource.data.status == "pending"
        && isTs(request.resource.data.sentAt)
        && isTs(request.resource.data.expiresAt)
        && isTs(request.resource.data.expiresAt)
        && isStr(request.resource.data.roomName);

      allow update: if signedIn()
        && resource.data.status == "pending"
        && resource.data.receiverId == uid()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(["status"])
        && request.resource.data.status in ["accepted","declined"];

      allow delete: if signedIn()
        && resource.data.status == "pending"
        && resource.data.senderId == uid();
    }
