    //firestore-rules\chats.rules
    // =========================================================================
    // CHATS
    // ✅ ARQUIVO MODULAR: NÃO pode ter `rules_version` nem `service cloud.firestore`.
    // =========================================================================
    match /chats/{chatId} {
      function isChatParticipant() {
        return signedIn() && (uid() in resource.data.participants);
      }

      allow read: if isChatParticipant();

      allow create: if signedIn()
        && (uid() in request.resource.data.participants)
        && request.resource.data.participants is list
        && request.resource.data.participants.size() >= 2
        && isTs(request.resource.data.timestamp)
        && (!request.resource.data.keys().hasAny(["participantsKey"]) || isStr(request.resource.data.participantsKey));


      allow update: if isChatParticipant()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          "lastMessage",
          "otherParticipantDetails",
          "timestamp"
        ]);

      allow delete: if false;
    }

    match /chats/{chatId}/messages/{messageId} {
      function isChatParticipantByChat() {
        return signedIn()
          && (uid() in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      }

      function senderIsMeCreate() {
        return (request.resource.data.senderId == uid())
          || (("senderUid" in request.resource.data) && request.resource.data.senderUid == uid());
      }

      function messageHasTime() {
        return ((request.resource.data.keys().hasAny(["timestamp"])) && isTs(request.resource.data.timestamp))
          || (("createdAt" in request.resource.data) && isTs(request.resource.data.createdAt));
      }

      allow read: if isChatParticipantByChat();

      allow create: if isChatParticipantByChat()
        && senderIsMeCreate()
        && isStr(request.resource.data.content) && request.resource.data.content.size() > 0
        && isStr(request.resource.data.nickname)
        && messageHasTime()
        && (!("status" in request.resource.data) || request.resource.data.status == "sent");

      allow update: if isChatParticipantByChat()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(["status"])
        && request.resource.data.status in ["delivered","read"]
        && (
          (("senderId" in resource.data) && resource.data.senderId != uid())
          ||
          (("senderUid" in resource.data) && resource.data.senderUid != uid())
        );

      allow delete: if false;
    }
